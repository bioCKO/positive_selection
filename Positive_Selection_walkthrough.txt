#WALKTHROUGH FOR DOING POSITIVE SELECTION ANALYSES ON CORAL TRANSCRIPTOMES
#VERY SIMILAR TO THE METATRANSCRIPTOMES WALKTHROUGH BUT WRITTEN AFTER
##Groves Dixon
#written 2/24/15
#last updated 9/19/16

#Set Variables for running jobs on TACC:
#Probably good to add these to your .bash_profile
allo="YOUR_ALLOCATION"
email="YOUR_EMAIL"



#--------------------------------------------------------------------------
#------------- STEP 1 DOWNLOAD AND PREP THE TRANSCRIPTOMES ----------------
#--------------------------------------------------------------------------
#(THESE LINKS ARE MORE FOR CONVENIENCE AND ARE NOT GUARANTEED TO WORK)
#TThey were last checked 1-12-17

#AIPTASIA FROM THE PRINGLE LAB
wget "http://pringlelab.stanford.edu/project%20files/SymTranscriptsClustered_id_99_frac_20_seeds_rereunRev%20(2).fa.gz" #Aiptasia
wget http://aiptasia.reefgenomics.org/download/aiptasia_genome.mRNA.fa.gz    #Gene models

#A.CERVICORNIS WAS OBTAINED FROM NCBI (accession number PRJNA222758)

#TRANSCRIPTOMES AVAILABLE FROM MEYER LAB WEBSITE (http://people.oregonstate.edu/~meyere/data.html)
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/MaurN/Maur_transcriptome_v1.fasta.gz" #Madracis auretenra
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/DstrN/Pstr_transcriptome_v1.fasta.gz" #Pseudodiploria strigosa
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/Fscu/Fscu_transcriptome_v1.fasta.gz" #Fungia scutaria
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/Shys/Shys_transcriptome_v1.fasta.gz" #Seriatopora hystrix
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/Mcav/Mcav_transcriptome_v1.fasta.gz" #Montastaea cavernosa
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/Aele/Aele_transcriptome_v1.fasta.gz" #Anthopleura elegantissima
wget "http://meyerlab:coral@files.cgrb.oregonstate.edu/Meyer_Lab/transcriptomes/Pdae/Pdae_v1.fasta.gz"               #Platygyra daedalea

#TRANSCRIPTOMES FROM MATZ LAB WEBSITE
wget "http://www.bio.utexas.edu/research/matz_lab/matzlab/Data_files/amil_july2014.zip" #Acropora millepora (by Moya)
wget "http://www.bio.utexas.edu/research/matz_lab/matzlab/Data_files/pastreoides_may2014.zip" #Porites asteoides
wget "http://www.bio.utexas.edu/research/matz_lab/matzlab/Data_files/aten_july2014.zip" #Acropora tenuis

#AVAILABLE FROM OIST MARINE GENOMICS UNIT (these have been revised since I downloaded them)
wget "http://marinegenomics.oist.jp/coral/download/adi_transcriptome_assembly.v1.fa.gz" #Acropora digitifera transcriptome 

#FROM ANDERSON ET AL. 2016 RNA-Seq of the Caribbean reef-building coral Orbicella faveolata (Scleractinia-Merulinidae) under bleaching and disease stress expands models of coral innate immunity
wget https://dfzljdn9uc3pi.cloudfront.net/2016/1616/1/SI_4a_coral_assembly.fasta.zip  #Orbicella faveolata

#FROM PALUMBI LAB WEBSITE 'Genomic basis for coral resilience to climate change'
wget http://palumbi.stanford.edu/data/33496_Ahyacinthus_CoralContigs.fasta.zip

#Cnidarian Database
wget "http://data.centrescientifique.mc/Data/454Isotigs.fas.zip" #Stylophora pistillata (Karako-Lampert et al. Plos One 2014)

#PocilloporaBase
wget "http://cnidarians.bu.edu/PocilloporaBase/cgi-bin/blast/contigs.fan" #Pocillopora damicornis

#BAUMS LAB
#this one has some different formatting, so do some followup adjustments
wget "https://usegalaxy.org/datasets/cb51c4a06d7ae94e/display?to_ext=fasta" #Acropora palmata (Polato et al. 2011)
sed -i.bak 's/"//g' Apalmata.fasta ##get rid of some quotation marks that are in there for some random reason


#PcarnBase
wget "http://www.comp.hkbu.edu.hk/~db/PcarnBase/db/nucleotide/CoralDNA" #Platygyra carnosus (Sun et al 2013)

#From Sarah Davies
wget ftp://marchanon:anon@rc-ns-ftp.its.unc.edu/Siderastrea_siderea_transcriptome.zip #Siderastrea siderea (Davies et al. 2016)

#From Kenkel lab
http://dornsife.usc.edu/labs/carlslab/data/


#BUILD JOINT CNIDARIAN DATABASE FROM  N.vectensis and A.digitifera PROTEOMES
wget ftp://ftp.jgi-psf.org/pub/JGI_data/Nematostella_vectensis/v1.0/annotation/transcripts.Nemve1FilteredModels1.fasta.gz #Nematostella transcriptome
wget ftp://ftp.jgi-psf.org/pub/JGI_data/Nematostella_vectensis/v1.0/annotation/proteins.Nemve1FilteredModels1.fasta.gz    #Nematostella proteome
wget http://marinegenomics.oist.jp/coral/download/adi_transcriptome_assembly.v1.fa.gz                                     #Acropora difitifera transcriptome
wget http://marinegenomics.oist.jp/coral/download/adi_aug101220_pasa_prot.fa.gz                                           #Acropora digitifera proteome
cat adi_v1.0.1.prot.fa transcripts.Nemve1FilteredModels1.fasta > cnidarianProteinDB.fasta

#INDEX THE COMBINED DATABASE FOR BLASTING
module load blast
echo "makeblastdb -in cnidarianProteinDB.fasta -dbtype prot" > mdb
echo "makeblastdb -in Adigitifera_prot.fa -dbtype prot" >> mdb
launcher_creator.py -j mdb -n mdb -a $allo -t 1:00:00
sbatch mdb.slurm

#ADD PATH TO THIS FILE TO YOUR .bashrc or .bash_profile FOR EASY ACCESS
export CNIDARIANDB="/work/02260/grovesd/Nvectensis_references/cnidarianProteinDB.fasta"

#ONCE ALL THE TRANSCRIPTOMES ARE DOWNLOADED, CHANGE THEIR NAMES TO MAKE THEM CONSISTENT
#BECAUSE WE'LL BE USING RAXML AND PAML, ITS EASIEST TO USE JUST THE FIRST 10 LETTERS FOR EACH SPECIES IDENTIFER FROM THE BEGINNING
#YOUR FINAL FILES SHOULD BE NAMED LIKE THIS
Acervicorn.fa
Adigitifer.fa
Aelegantis.fa
Ahyacinthu.fa
Amillepora.fa
Apallida.fa
Apalmata.fa
Atenuis.fa
Fscutaria.fa
Mauretenra.fa
Mcavernosa.fa
Ofaveolata.fa
Nvectensis.fa
Pastreoide.fa
Paustralie.fa
Pcarnosus.fa
Pdaedalea.fa
Pdamicorni.fa
Plobata.fa
Pstrigosa.fa
Shystrix.fa
Spistillat.fa
Ssiderea.fa

#GET SOME SUMMARY DATA ABOUT EACH TRANSCRIPTOME USING SEQ_STATS.PL by Eli Meyer
>runStats;>seqStats.txt; >runStats; for file in *.fa; do echo "seq_stats.pl $file >> seqStats.txt" >> runStats; done
launcher_creator.py  -n runStats -j runStats -q normal -t 2:00:00 -N 1 -w 48 -a tagmap
sbatch runStats.slurm

###################### CLEANING DEFINITION LINES ######################

#DOWNSTREAM IT WILL BE EASIER IF EACH CONTIG IS DEFINED ONLY WITH A SINGLE IDENTIFYING STRING
#CLEAN UP THE SEQUENCE DEFINITIONS USING CLEAN_SEQ_DEFINITIONS.PY
#Acervicorn.fa
clean_seq_definitions.py -i Acervicorn.fa -o Acervicorn_clean.fa -pos 1
#Adigitifera - already good
cp Adigitifer.fa Adigitifer_clean.fa
#Aelegantisima
clean_seq_definitions.py -i Aelegantis.fa -o Aelegantis_clean.fa -pos 1
#Ahyacinthus - already good
cp Ahyacinthu.fa Ahyacinthu_clean.fa 
#Amillepora
clean_seq_definitions.py -i Amillepora.fa -o Amillepora_clean.fa -pos 1
#Apallida
cp Apallida.fa Apallida_clean.fa
#Apalmata - already good
cp Apalmata.fa Apalmata_clean.fa
#Atenuis
clean_seq_definitions.py -i Atenuis.fa -o Atenuis_clean.fa -pos 1
#Fscutaria
clean_seq_definitions.py -i Fscutaria.fa -o Fscutaria_clean.fa -pos 1
#Mauretenra
clean_seq_definitions.py -i Mauretenra.fa -o Mauretenra_clean.fa -pos 1
#Mcavernosa
clean_seq_definitions.py -i Mcavernosa.fa -o Mcavernosa_clean.fa -pos 1
#Ofaveolata
clean_seq_definitions.py -i Ofaveolata.fa -o Ofaveolata_clean.fa -pos 1
#Nvectensis - already good
cp Nvectensis.fa Nvectensis_clean.fa
#Pastreoides
clean_seq_definitions.py -i Pastreoide.fa -o Pastreoide_clean.fa -pos 1
#Paustraliensis
clean_seq_definitions.py -i Paustralie.fa -o Paustralie_clean.fa -pos 1
#Pcarnosus -already good
cp Pcarnosus.fa Pcarnosus_clean.fa
#Pdaedalea
clean_seq_definitions.py -i Pdaedalea.fa -o Pdaedalea_clean.fa -pos 1
#Pdamicornis - already good
cp Pdamicorni.fa Pdamicorni_clean.fa
#Plobata
clean_seq_definitions.py -i Plobata.fa -o Plobata_clean.fa -pos 1
#Pstrigosa
clean_seq_definitions.py -i Pstrigosa.fa -o Pstrigosa_clean.fa -pos 1
#Shystrix
clean_seq_definitions.py -i Shystrix.fa -o Shystrix_clean.fa -pos 1
#Spistillata
clean_seq_definitions.py -i Spistillat.fa -o Spistillat_clean.fa -pos 1
#Ssiderea
clean_seq_definitions.py -i Ssiderea.fa -o Ssiderea_clean.fa -pos 1


ls *clean.fa | wc -l
		#23

##################################################################

#NOW MOVE THE ORIGINALS INTO ANOTHER DIRECTORY AND SWITCH THE NAMES OF THE CLEAN FILES BACK
rename _clean.fa .fa *.fa

#NOW ALL THE TRANSCRIPTOMES HAVE SINGLE IDENTIFYING SEQUENCE IDENTIFIERS
#MOVE THEM INTO THEIR OWN DIRECTORY BEFORE CONTINUING SO THEY ARE YOUR ONLY .fa FILES

#--------------------------------------------------------------------------------------
#------- STEP 2 EXTRACT PROTEIN AND CODING SEQUENCES BASED ON REFERENCE PROTEOMES -----
#--------------------------------------------------------------------------------------

#HERE YOU WILL USE THE "CNIDARIAN DATABASE" ASSEMBLED ABOVE.

#BLAST EACH INDIVIDUAL TRANSCRIPTOME AGAINST THE COMBINED (DIGITIFERA + NEMATOSTELLA) PROTEIN DATABASE

#LOAD THE BLAST MODULE
module load blast

#CHOOSE THE DATABASE YOU WANT TO EXTACT PROTEINS FROM
#I noticed that using the Nvectensis-Adigitifera concatenation resulted in no orthologs from N.vectensis
#Trying just Adigitifera
BDB="/work/02260/grovesd/lonestar/anthozoan_transcriptomes/protein_databases/Adigitifera_prot.fa"


#MAKE AN EMPTY COMMANDS FILE
>doblast
for file in *.fa; do echo blastx -query $file -db $BDB -evalue 1e-5 -num_threads 12 -num_descriptions 5 -num_alignments 5 -out ${file/.fa/}.br >> doblast; done
launcher_creator.py -j doblast -n doblast -l doblast.job -a tagmap -q normal -t 8:00:00 -a tagmap -e grovesdixon@gmail.com -N 1 -w 48
sbatch doblast.job

#RUN CDS EXTRACTOR ON THE BLAST OUTPUTS *(note this doesn't seem to like overwriting files, so you may need to remove old output files first if running multiple times)
#CDS_extractor_v2.pl BY MIKHAIL MATZ USES BIOPERL TO EXTRACT CODING NUCLEOTIDE SEQUENCES AND PROTEIN SEQUENCES FROM TRANSCRIPTOMES BASED ON HITS TO A REFERENCE PROTEOME.

module load bioperl
>extract; for file in *.fa; do echo "CDS_extractor_v2.pl $file ${file/.fa/}.br allhits bridgegaps" >> extract ; done
launcher_creator.py -j extract -n extract -t 5:00:00 -N 2 -a $allo -e $email
sbatch extract.slurm

#CHECK IF YOU GOT BACK CDS FILES FOR ALL SPECIES
ls *CDS.fas | wc -l

#--------------------------------------------------------------------------------------
#-------------------- STEP 2 GETTING ORTHOLOGS FOR PHYLOGENY --------------------------
#--------------------------------------------------------------------------------------
#BLAST ALL THE EXTRACTED PROTEIN SEQUENCES AGAINST ONE ANOTHER

#MAKE A BLAST DATABASE FOR EACH SPECIES
module load blast
> makeDBs; for file in *PRO.fas; do  echo makeblastdb -in $file -dbtype prot >> makeDBs; done
launcher_creator.py -j makeDBs -n makeDBs -e $email -a $allo -N 24 -q normal -t 1:00:00
sbatch makeDBs.slurm


#NOW BLAST ALL AGAINST ALL
paired_blasts_launcher.py *PRO.fas > doblasts
launcher_creator.py -n doblasts -j doblasts -q normal -t 8:00:00 -N 10 -a $allo -e $email
sbatch doblasts.slurm
#took about 5 hours with 120 cores


#PULL THE TOP HITS FOR EACH BLAST RESULTS FILE AND OUTPUT AS TEXT FILES
COV="75"
PCTID="75"
>getBestHits;for file in *.br; do query=${file/-*_PRO.fas.br/}; db=${file/*-/}; echo "find_best_hits.py -br $file -query $query -db ${db/.br/} -o $query-${db/.br/}.hits -cov $COV -pctID $PCTID" >> getBestHits; done
launcher_creator.py -n getBestHits -j getBestHits -t 1:00:00 -a $allo -e $email
sbatch getBestHits.slurm

#CONCATENATE THE TOP HITS FILES 
>all_top_hits.txt; for file in $(ls *.hits); do cat $file >> all_top_hits.txt; done

#USE THE TOP HITS TO PULL OUT RECIPROCAL ORTHOLOGS
echo "get_multireciprocal_orthos2.py -hits all_top_hits.txt -fa *PRO.fas -o reciprocalOrthos_cov75_pctID75.txt -anchor Amillepora_PRO.fas" > getRecips
launcher_creator.py -n getRecips -j getRecips -q development -t 1:00:00 -a $allo -e $email
sbatch getRecips.slurm

##========================================================================================================================

#-----------------------------------------------------------------------------------
#-------------------- PART 4 ALIGN ORTHOLOGS FOR PHYLOGENY CONSTRUCTION ------------
#-----------------------------------------------------------------------------------
#ASSEMBLE ALL THE CDS.fas AND PRO.fas FILES INTO A NEW DIRECTORY WITH THE reciprocal Ortholog table

#GET ORTHOLOG STATS AND OUTPUT REDUCED ORTHOLOGS BASED ON REPRESENTATION
#note you can repeat this as many times as you want from the same original reciprocalOrthos_cov75_pctID75.txt
orthologStats.py reciprocalOrthos_cov75_pctID75.txt 0.8

#FIRST OUTPUT FASTA FILES FOR EACH GENE IN THE ORHTOLOG TABLE BY PULLING THE SEQUENCES FROM THEIR PROTEIN FASTA FILES
echo "output_ortholog_seqs.py -prot *PRO.fas -nucl *CDS.fas -orthos reciprocalOrthos_cov75_pctID75_rep0.6.txt" > orthoOuter
GDlauncher_creator.py -j orthoOuter -n orthoOuter -l orthoOuter.job -q development -c 12
qsub orthoOuter.job

#USE MAFFT TO MAKE MULTIPLE ALIGNMENTS OF THE ORTHOLOG PROTEIN SEQUENCES
#NOTE THAT THIS DOESN'T RUN WHEN YOU DO IT THROUGH A JOB. I GOT IT TO WORK BY RUNNING ON FRONT NODES.
module load mafft
>align;for fa in *prot.fasta; do echo "mafft --localpair --maxiterate 1000 $fa > ${fa/.fasta/}.aln" >> align; done

#WE NEED TO THESE BE HIGH QUALITY ALIGNMENTS OF REAL ORHTOLOGS. SO THESE ARE WORTH LOOKING AT MANUALLY. 
>alignments.txt; for file in *.aln; do echo $file >> alignments.txt; echo ${file/.aln/} >> alignments.txt; cat $file >> alignments.txt; done &


##USE PAL2NAL TO REVERSE TRANSLATE THE PROTEIN ALIGNMENTS BACK INTO CODONS BASED ON THE CDS FILES
for aln in *.aln; do pal2nal.pl $aln ${aln/prot.aln/}nuc.fasta -output paml -nogap > ${aln/_prot.aln/}.codon; done

#BUILD A SPECIES LIST FOR EASY ACCESS TO THE SPECIES NAMES
#note this works by calling on the original transcriptome files, so if you have them elsewhere it won't work.
>speciesList.txt; for i in *CDS.fas; do echo ${i/_CDS.fas/} >> speciesList.txt; done

#CONCATENATE THE CODON SEQUENCES INTO A NEXUS FILE
concatenate_genes_into_nexus.py -spp speciesList.txt -f *.codon -o seqs.nex

#-----------------------------------------------------------------------------------
#-------------------- PART 5 USING RAxML TO BUILD TREE ----------------------------
#-----------------------------------------------------------------------------------

module load raxml

#CONVERT THE NEXUS FILE INTO A PHYLIP FILE
#(I originally planned to use BEAST, but found raxML better suited to my level)
nex2phy.py -i seqs.nex

#SET UP SOME VARIABLES FOR RUNNING THE raxML COMMAND
S="seqs.phy"                              #the sequence file
Q="seqs_partitions.txt"                   #the sequence partition file (separates the concatenated seqs into genes)
R="T1"                                    #the run name (this must be different for each run)
N="1000"                                 #iterations for bootstrapping (10K may be too many if you have a lot of genes, but is nice for 100 - 200 genes)

#RUN raxML USING THE 'RAPID' ALGORITHM
echo raxmlHPC-PTHREADS-SSE3 -s $S -n $R -m GTRGAMMA -f a -p 12345 -x 12345 -N $N -T 12 -q $Q -o Apallida,Nvectensis,Aelegantis > rapid_c80TreeBoot
launcher_creator.py -n rapid_c80TreeBoot -j rapid_c80TreeBoot -q normal -t 24:00:00
sbatch rapid_c80TreeBoot.sge

#LOOK AT THE RESULT
cat RAxML_bipartitions.T1

#gives this tree
((((Mauretenra:0.04049560526638333602,(Pdamicorni:0.03635664418759038813,(Spistillat:0.01669901916429573571,Shystrix:0.02535604845518168310)100:0.01934706435820400874)100:0.05942502345255143426)100:0.04964381592369235263,(((Pstrigosa:0.03715487598860617302,((Pcarnosus:0.00545320258579240838,Pdaedalea:0.00347997338944650491)100:0.02534889091642321055,Ofaveolata:0.02280409048137715597)100:0.00652148567213208658)100:0.01017014579861029618,Mcavernosa:0.02549894600826191349)100:0.03031657724494806957,Fscutaria:0.07092718247263622711)100:0.01824526436424617898)100:0.03235225443104135234,(((Atenuis:0.01328304992827550671,((Apalmata:0.00101940106719560397,Acervicorn:0.00448065727343643135)100:0.00562218523669647322,((Amillepora:0.00468134808173732275,Ahyacinthu:0.00531442986384068373)100:0.00154549551385545604,Adigitifer:0.00514259531386163961)100:0.00223441156053417588)100:0.00762659115588722181)100:0.17596347441677492873,Ssiderea:0.06222588564325232108)99:0.01469767506590902509,Pastreoide:0.12477285757756050033)100:0.02328249976708623645)100:0.45000000000000001110,(Nvectensis:0.24286671708244961243,(Apallida:0.19657330344545928535,Aelegantis:0.13941618788778337157)100:0.09563085410170717171)100:0.45000000000000001110);
#-------------------------------------------------------------------------------------------------
#-------------------- PREPARE FILES FOR EACH GENE TO RUN PAML ------------------------------------
#-------------------------------------------------------------------------------------------------

#BEFORE WE PULLED ORTHOLOGS STRICTLY TO BUILD THE PHYLOGENETIC TREE
#NOW WE WILL RELAX THE ORTHOLOG STRINGENCY TO GET MORE GENES
##This gets really messy because you make so many files (there was probably a better way to do this)
#it's necessary to go back to the blast results files if you want to use new filters (like a lower coverage rate or lower pct identity)
#assemble all the PRO.fas and .br blast results files into a single directory

#PULL THE TOP HITS FOR EACH BLAST RESULTS FILE AND OUTPUT AS TEXT FILES
#set the coverage and percent identity you want
COV="75"
PCTID="25"
>getBestHits;for file in *.br; do query=${file/-*_PRO.fas.br/}; db=${file/*-/}; echo "find_best_hits.py -br $file -query $query -db ${db/.br/} -o $query-${db/.br/}.hits -cov $COV -pctID $PCTID" >> getBestHits; done
launcher_creator.py -n getBestHits -j getBestHits -q normal -t 2:00:00 -a $allo
sbatch getBestHits.slurm

#CONCATENATE THE TOP HITS FILES 
>all_top_hits.txt; for file in *.hits; do cat $file >> all_top_hits.txt; done

#USE THE TOP HITS TO PULL OUT RECIPROCAL ORTHOLOGS
#note here the -rcut argument sets requirement that all sequences within an orthologous group are reciprocal best hits to all others
echo "get_multireciprocal_orthos2.py -hits all_top_hits.txt -fa *PRO.fas -o reciprocalOrthos_cov75_pctID25.txt -anchor Amillepora_PRO.fas -rcut 1.0" > getRecips
launcher_creator.py -n getRecips -j getRecips -q normal -t 1:00:00 -a $allo -e $email
sbatch getRecips.slurm


#GET ORTHOLOG STATS AND OUTPUT REDUCED ORTHOLOGS BASED ON REPRESENTATION
orthologStats.py reciprocalOrthos_cov75_pctID25.txt 0.2

#results:
	Of 30528 total genes...
	7821 had at least 4 representative species and were kept
	22707 were rejected because they did not have enough species

			#old results if you used -rcut 0.5 instead of 1.0
				Of 30528 total genes...
				9728 had at least 4 representative species and were kept
				20800 were rejected because they did not have enough species

#FIRST OUTPUT FASTA FILES FOR EACH GENE IN THE ORHTOLOG TABLE BY PULLING THE SEQUENCES FROM THEIR PROTEIN FASTA FILES

#set the ortholog table you want to use
orthoTable='reciprocalOrthos_dS_pass_cov75_full_rep.2.txt'  #use this one before FastOrtho filtering
orthoTable='fastOrtho_filtered.tsv'  #use this one after FastOrtho filtering

#use the ortholog table to output sets of orthologs as single files
echo "output_ortholog_seqs.py -prot *PRO.fas -nucl *CDS.fas -orthos $orthoTable" > orthoOuter
launcher_creator.py -j orthoOuter -n orthoOuter -q development -w 12 -N 1 -e $email -a $allo -t 1:00:00
sbatch orthoOuter.slurm


#Setting up subsets of orthologs for particular taxa
#This was done in order to run sites tests based only on particular clades
#make a directory for each subset you want (eg only acroporid sequences)
mkdir acro_only
cd acro_only

#make symbolic links to the output sequences
ln -s *nuc.fasta .
ln -s *prot.fasta .

#make a list of the taxa you want to subset for
nano acroporids.txt
Acervicorn
Adigitifer
Ahyacinthu
Amillepora
Apalmata
Atenuis


#filter the fasta files
>subset;for file in *.fasta; do echo "subset_fasta.py $file acroporids.txt > $file.sub" >> subset; done
launcher_creator.py -n subset -j subset -q normal -t 1:00:00 -a $allo -N 12
sbatch subset.slurm


#move them into their own directory and rename them
mkdir subsetted
mv *.sub subsetted
cd subsetted
rename .fasta.sub .fasta *.fasta.sub

#the above steps could be repeated for any set of taxa
#(also keep a directory with the ortholog sequences for all taxa)

#use MAFFT to align the protein sequences
#note on lonestar5 the module isn't installed yet, and I had to install it myself from here: http://mafft.cbrc.jp/alignment/software/installation_without_root.html
>align;for fa in *prot.fasta; do echo "mafft --localpair  --maxiterate 1000 $fa > ${fa/.fasta/}.aln" >> align; done
launcher_creator.py -n align -j align -t 3:00:00 -q normal -a $allo -N 1 -w 48
sbatch align.slurm



#MAKE SURE YOU HAVE ALL YOUR ALIGNMENTS
ls *aln | wc -l


##USE PAL2NAL TO REVERSE TRANSLATE TO CODONS
>reverseTrans; for aln in *.aln; do echo "pal2nal.pl $aln ${aln/prot.aln/}nuc.fasta -output paml -nogap > ${aln/_prot.aln/}.codon" >> reverseTrans; done
launcher_creator.py -n reverseTrans -j reverseTrans -q normal -t 2:00:00 -a $allo -N 1 -w 48
sbatch reverseTrans.slurm


#MAKE SURE THAT YOU'RE REVERSE TRASLATING ALL THE FILES
cat reverseTrans | wc -l


#MAKE SURE YOU STILL HAVE ALL YOUR FILES
ls *.codon | wc -l

#NOW WE HAVE CODON FILES TO USE FOR OUR PAML ANALYSES

#-----------------------------------------------------------------------------------------------
#-------------------- RUN PAML TO GET PAIR-WISE COMPARISONS ------------------------------------
#-----------------------------------------------------------------------------------------------

#GET YOUR BEST TREE FROM RAxML
#Here the tree does not need to have node labels or terminal branch labels (see Tree_file_notes.txt)
#The tree is actually irrelevant here, I just kept it so this would be consistent with the next steps
TREE="c80TREE.txt"

#PASTE A TREE INTO THE TREE FILE
nano $TREE
#PASTE IN THE TREE (it doesn't really matter here)
((((Mauretenra:0.04049556322121231761,(Pdamicorni:0.03635664748188224826,(Shystrix:0.02535597151460658796,Spistillat:0.01669906071368057812):0.01934700857646708128):0.05942504128543446562):0.04964388854474626606,(Fscutaria:0.07092711055729530867,(Mcavernosa:0.02549888227118697615,(Pstrigosa:0.03715483621775966111,(Ofaveolata:0.02280405020307265176,(Pcarnosus:0.00545319715309268600,Pdaedalea:0.00347996932930244194):0.02534887871727259726):0.00652148383306768581):0.01017020139382859498):0.03031658136871610842):0.01824518984990905132):0.03235225034021282919,(((Atenuis:0.01328304181230683702,((Adigitifer:0.00514255563691862899,(Ahyacinthu:0.00531439003981734170,Amillepora:0.00468131586837905369):0.00154550737263727889):0.00223439747583365498,(Apalmata:0.00101940024023222946,Acervicorn:0.00448065123662298725):0.00562218928347253937):0.00762658432620265652):0.17596341205162616128,Ssiderea:0.06222573452979433817):0.01469762099026128942,Pastreoide:0.12477276331600407888):0.02328256350260949833):0.45000000000000001110,((Apallida:0.19657351664710145944,Aelegantis:0.13941647491281378146):0.09562983577915853961,Nvectensis:0.24286668458986779284):0.45000000000000001110);

#IF YOU DIDN'T GRAB THE SPECIES LIST FROM BEFORE, COPY IT OVER INTO YOUR WORKING DIRECTORY

##BUILD A PAML CONTROL FILE FOR EACH GENE
>buildControls;for file in *.codon; do echo "build_paml_control.py -i $file -t $TREE -spp speciesList.txt -runMode -2" >> buildControls; done
launcher_creator.py -n buildControls -j buildControls -w 12 -N 1 -t 1:00:00 -q development -a $allo
sbatch buildControls.slurm


#MAKE SURE YOU HAVE ALL YOUR CONTROL FILES
ls *cnt | wc -l


#RUN CODEML
>runCodeml; for file in *.cnt; do echo "codeml $file" >> runCodeml; done
launcher_creator.py -n runCodeml -j runCodeml -w 12 -q normal -t 10:00:00 -a $allo -q normal -N 3
sbatch runCodeml.slurm


##NOW PARSE THE CODEML OUTPUTS
>parse; while read line; do echo "parse_codeml_pairwise_output.py -f *.codeml -spp1 $line -sppList speciesList.txt -o pair-wise_dNdS_${line}.txt -orthos reciprocalOrthos_cov75_pctID25_rep0.2.txt" >> parse; done < speciesList.txt
launcher_creator.py -n parse -j parse -w 12 -N 1 -t 1:00:00 -e $email -a $allo
sbatch parse.slurm


#-----------------------------------------------------------------------------------------
#--------- FILTERING ORTHOLOGS BASED ON PAIRWISE COMPARISONS AND FAST ORTHO---------------
#-----------------------------------------------------------------------------------------
#now that we have pair-wise dN and dS estimates we can use them to clean out false positives from the dataset
#we used Amillepora as the anchor, so those sequences are out base ortholog
#we assume that the majority of called orthologs are real, and that false ones will represent 
#a distinct cluster of dS values.
#send the pair-wise_dNdS_Amillepora.txt file to Mac and output filtered ortholog sets using filter_orthologs.R
#Use the set of filtered orhtologs for all downstream analyses
#now return to where you have the CDS and PRO files and and re-output the ortholog
#once you have the new set of orthologs, re-align and re-reverse translate them for a new set of .codon files
#then use those for the downstream paml analyses

##NOW FILTER THESE ORTHOLOGS USING filter_orthologs.R
filter_orthologs_lonestar.R reciprocalOrthos_cov75_pctID25_rep0.2.txt


#output is a file called reciprocalOrthos_dS_pass_wide.txt

#use this to output a fresh set of orthologs that are dS filtered

#for further filtering, get consensus orthologs between this set
#and one generated using FastOrtho (see fastOrtho_TACC_WALKTHROUGH.txt)

cross_check_orthos.py -orthos reciprocalOrthos_dS_pass_wide.txt -o fastOrtho_filtered.tsv -fOrthos run1.end


#once you have a final set of confident ortholog calls, return to the output_ortholog_seqs.py step above

#----------------------------------------------------------------------------------------------------------
#--------------------------------- RUN CODEML TO GET OVERALL MEAN OMEGA -----------------------------------
#----------------------------------------------------------------------------------------------------------

#This should work in the same directory, but just to keep things simpler I like to copy of the .codon files and speciesList to a new directory

#GET YOUR BEST TREE FROM RAxML
#here I had to do some tree formatting. First I remove all bootstrap values from the newick format
#because these make the labels for PAML less clear. Then I use Dendroscope to make sure the tree is rooted from the NODE leading 
#to the actiniarian species (N.vectensis, A.elegantissima, and A. pallida)
#the script 'build_paml_control.py' should ensure that even when terminal taxa are pruned from the tree it remains unrooted (a trifurcation at base)
#recommend saving the tree formatted for paml specifcally

#COPY THE TREE OVER AND SAVE AS $TREE
#MAKE SYMBOLIC LINKS FOR THE .CODON FILES FROM WHEREEVER YOU HAVE THEM
#eg ln -s ../sequences/*.codon .

##BUILD A PAML CONTROL FILE FOR EACH GENE
TREE=c80TREE.txt
>buildControls;for file in *.codon; do echo "build_paml_controlsV2.py -i $file -t $TREE -spp speciesList.txt -runMode 0 -NSsites 0 -model 0 -controlName ${file/.codon/_M0.cnt} -o ${file/.codon/_M0.codeml}" >> buildControls; done
launcher_creator.py -n buildControls -j buildControls -w 12 -N 1 -t 4:00:00 -a $allo -q normal -e $email
sbatch buildControls.slurm


#MAKE SURE YOU HAVE ALL OF YOUR CONTROL FILES
ls *cnt | wc -l


#RUN CODEML
>runCodemlM0; for file in *M0.cnt; do echo "codeml $file" >> runCodemlM0; done 
launcher_creator.py -n runCodemlM0 -j runCodemlM0 -t 8:00:00 -a tagmap -N 1 -w 48 -q normal
sbatch runCodemlM0.slurm


#GATHER THE RESULTS
>results.txt; for file in *M0.codeml; do dnds=$(grep "omega (dN/dS)" $file); echo -e "${file/_M0.codeml/}\t$dnds" >> results.txt; done
cat results.txt | awk '{print $1","$5}' > mean_omega.csv

#scp to PC for analysis


#----------------------------------------------------------------------------------------------------------------------------
#--------------------------------- RUN SITES TEST ON ORTHOLOGS WITH ONLY ACROPORA SPECIES -----------------------------------
#----------------------------------------------------------------------------------------------------------------------------
#OVERVIEW:
#Here we are running the a sites test in CODEML (PAML manual)
#we will restrict the phylogeny to only Acroporids
#We run the null model M1a that does not allow omega > 1, and the alternative model M2a that does
#Likelihood ratio tests between the two models may identify genes with sites showing evidence of positive selection
#Use 2 degrees of freedom for likelihood ratio test (PAML manual/Beginnersguild-dnds.pdf)
#control file settings for the alternative and null model are shown below:
#ALTERNATIVE:
	#model     = 0
	#NSsites   = 2
#NULL
	#model     = 2
	#NSsites   = 2

#make a new directory and make symbolic links to the .codon files
#we only want acroporid sequences for this one, so we need to trim other species from the .codon files
nano acroporids.txt
Acervicorn
Adigitifer
Ahyacinthu
Amillepora
Apalmata
Atenuis


TREE=c80TREE.txt

#BUILD THE PAML CONTROL FILES FOR RUNNING THE NULL MODEL
>buildControlsNull;for file in *.codon; do echo "build_paml_controlsV2.py -i $file -t $TREE -spp speciesList.txt -runMode 0 -model 0 -NSsites 1 -fix_omega 0 -controlName ${file/.codon/_NULL.cnt} -o ${file/.codon/_NULL.codeml}" >> buildControlsNull; done &
launcher_creator.py -n buildControlsNull -j buildControlsNull -w 48 -N 1 -a $allo -t 5:00:00 -q normal
sbatch buildControlsNull.slurm



#TEST ONE COMMAND TO BE SURE ITS WORKING
head buildControlsNull

#RUN THE JOB
launcher_creator.py -n buildControlsNull -j buildControlsNull -w 48 -N 1 -a $allo -t 5:00:00 -q normal
sbatch buildControlsNull.slurm


#BUILD THE PAML CONTROL FILES FOR RUNNING THE ALTERNATIVE MODEL
#note the tree files will overwrite, but that's ok
>buildControlsALT;for file in $(ls *.codon); do echo "build_paml_controlsV2.py -i $file -t $TREE -spp speciesList.txt -runMode 0 -model 0 -NSsites 2 -fix_omega 0 -controlName ${file/.codon/_ALT.cnt} -o ${file/.codon/_ALT.codeml}" >> buildControlsALT; done &
launcher_creator.py -n buildControlsALT -j buildControlsALT -w 48 -N 1 -a $allo -t 5:00:00 -q normal
sbatch buildControlsALT.slurm



#RUN THE NULL MODEL
> runNullModel; for file in *NULL.cnt; do echo codeml $file >> runNullModel; done &
launcher_creator.py -n runNullModel -j runNullModel -q normal -t 12:00:00 -N 1 -w 48 -a $allo
sbatch runNullModel.slurm

> runAltModel; for file in *ALT.cnt; do echo codeml $file >> runAltModel; done &
launcher_creator.py -n runAltModel -j runAltModel -q normal -t 12:00:00 -N 1 -w 48 -a $allo
sbatch runAltModel.slurm

#check they all ran
ls *NULL.codeml | wc -l
ls *ALT.codeml | wc -l

#ASSEMBLE LIKELIHOODS FOR NULL MODELS
>nullResults;for file in *NULL.codeml; do dat=$(grep lnL $file); echo "${file/_NULL.codeml/}   $dat" >> nullResults;  done &

#ASSEMBLE LIKELIHOODS FOR NULL MODELS
>altResults;for file in *ALT.codeml; do dat=$(grep lnL $file); echo "${file/_ALT.codeml/}   $dat" >> altResults;  done &


#MAKE SURE THESE FILES HAVE THE FIGHT NUMBER OF LINES
cat altResults | wc -l
cat nullResults | wc -l

#PARSE THE DATA INTO TABLES
parse_codeml_branch_sites.py -i nullResults -o nullLikelihoods_Sites.txt
parse_codeml_branch_sites.py -i altResults -o altLikelihoods_Sites.txt

#===============================================================================================

#-----------------------------------------------------------------------------------------------------------------------------------------------
#--------------------------------- RUN PAML TO TEST FOR EVIDENCE OF LINEAGE/SITE-SPECIFIC SUBSTITUTION RATES -----------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------

#OVERVIEW:
#Here we are running the "Branch-site test for positive selection" (PAML manual)
#We run the alternative model A and the Null model A
#Likelihood ratio tests between the two models may identify genes under positive selection in our specified lineage
#Use one degree of freedom for likelihood ratio test (PAML manual)
#control file settings for the alternative and null model are shown below:
#ALTERNATIVE:
	#model     = 2
	#NSsites   = 2
	#fix_omega = 0
#NULL
	#model     = 2
	#NSsites   = 2
	#fix_omega = 1
	#omega     = 1

#each of the two models allows W to vary between sites and between branches.
#Which branches (lineages) can have their own W values is assigned in the tree file

#I LIKE TO RUN THIS IN ITS OWN DIRECTORY TOO
#IF YOU'RE USING THE SAME SETS OF GENES YOU CAN JUST COPY THE *.codon FILES OVER FROM THE PAIRED-END ANALYSIS



#GET YOUR BEST TREE FROM RAxML
#here I had to do some tree formatting. First I remove all bootstrap values from the newick format
#because these make the labels for PAML less clear. Then I use Dendroscope to make sure the tree is rooted from the NODE leading 
#to the actiniarian species (N.vectensis, A.elegantissima, and A. pallida)
#the script 'build_paml_control.py' should ensure that even when terminal taxa are pruned from the tree it remains unrooted (a trifurcation at base)
#recommend saving the tree formatted for paml specifcally



#To build control files that are specific to the Acroporid branch
#we need to tell the builder script which taxa are from that lineage
#so make a subset of the species list for just the acroporids

nano acroporids.txt

#paste in the names of the acroporid species
Acervicorn
Adigitifer
Ahyacinthu
Amillepora
Apalmata
Atenuis


#IF RUNNING FOR ALL NON ACROPORIDS, MAKE AN ALTERNATE LIST
nano robust.txt
Fscutaria
Mauretenra
Mcavernosa
Ofaveolata
Pcarnosus
Pdaedalea
Pdamicorni
Pstrigosa
Shystrix
Spistillat



#SET APPROPRIATE FILE VARIABLES
CLADE=robust.txt
TREE=c80TREE.txt
INCLUSIVE=no

#BUILD THE PAML CONTROL FILES FOR RUNNING THE NULL MODEL
>buildControlsNull;for file in *.codon; do echo "build_paml_control_positive.py -inc $INCLUSIVE -i $file -t $TREE -spp speciesList.txt -runMode 0 -model 2 -NSsites 2 -fix_omega 1 -omega 1 -controlName ${file/.codon/_NULL.cnt} -clade $CLADE -o ${file/.codon/_NULL.codeml}" >> buildControlsNull; done &


#test one to be sure it's working
head buildControlsNull

#run job
launcher_creator.py -n buildControlsNull -j buildControlsNull -w 48 -N 1 -e $email -a $allo -t 5:00:00 -q normal
sbatch buildControlsNull.slurm


#MAKE A LOG OF ALL THE TREES FOR MANUAL INSPECTIONS
print_tree.py -i *.tree > ortholog_trees.txt &

#BUILD THE PAML CONTROL FILES FOR RUNNING THE ALTERNATIVE MODEL
#note the tree files will overwrite, but that's ok
>buildControlsALT;for file in *.codon; do echo "build_paml_control_positive.py -inc $INCLUSIVE -i $file -t $TREE -spp speciesList.txt -runMode 0 -model 2 -NSsites 2 -fix_omega 0 -controlName ${file/.codon/_ALT.cnt} -clade $CLADE -o ${file/.codon/_ALT.codeml}" >> buildControlsALT; done &
launcher_creator.py -n buildControlsALT -j buildControlsALT -w 48 -N 1 -a $allo -t 5:00:00 -q normal
sbatch buildControlsALT.slurm

#CHECK ALL THE CONTROL FILES WERE MADE
ls *ALT.cnt | wc -l
ls *NULL.cnt | wc -l
#note here that the minimum foreground and background taxa are both set at two by default in build_paml_control_positive.py
#if these criteria are not met, a control file is still output, but with _FAIL appended to it
#this way you can keep count of how many failed due to taxon representation
ls *ALT.cnt_FAIL | wc -l
#this should return a number of files such that the sum of failed and created files is equal to the number of *.codon files

#RUN THE NULL MODEL
> runNullModel; for file in *NULL.cnt; do echo codeml $file >> runNullModel; done &
launcher_creator.py -n runNullModel -j runNullModel -q normal -t 24:00:00 -N 1 -w 48 -a $allo
sbatch runNullModel.slurm

> runAltModel; for file in *ALT.cnt; do echo codeml $file >> runAltModel; done &
launcher_creator.py -n runAltModel -j runAltModel -q normal -t 24:00:00 -N 1 -w 48 -a $allo -e $email
sbatch runAltModel.slurm


#ASSEMBLE LIKELIHOODS FOR NULL MODELS
>nullResults;for file in *NULL.codeml; do dat=$(grep lnL $file); echo "${file/_NULL.codeml/}   $dat" >> nullResults;  done &

#ASSEMBLE LIKELIHOODS FOR NULL MODELS
>altResults;for file in *ALT.codeml; do dat=$(grep lnL $file); echo "${file/_ALT.codeml/}   $dat" >> altResults;  done &

#PARSE THE DATA INTO TABLES
parse_codeml_branch_sites.py -i nullResults -o nullLikelihoods_branchSites.txt
parse_codeml_branch_sites.py -i altResults -o altLikelihoods_branchSites.txt

#ANALYZE THE DATA WITH FIRST WITH LRT_for_branch_sites_models.R

#--------------------------------------------------------------
#-------------- DOWNSTREAM ANALYSES ---------------------------
#--------------------------------------------------------------
#DOWNSTREAM ANALYSES ARE PERFORMED WITH R scripts MBD-seq_analysis1-6
#THESE WILL INCLUDE DATA OUTPUT FROM THE MBD-SEQ DATA PROCESSSING (walkthrough for this is called MBD-seq_Data_Processsing_Walkthrough.txt)

#GO ENRICHMENT FOR MBD-SCORES
#export the input data using MBD-seq_analysis1_distribution.R
#use GO_MWU_MBD-seq_enrichment.R to generate figures

#KOGG ENRICHMENT FOR MBD-SCORES
#export the input data using MBD-seq_analysis1_distribution.R
#use kog_MWU_for_MBD_enrichment.R to generate enrichment data and heatmap figure

#to output PAML results for a given kogs use 'output_kog.R'
#to output sets of GO terms use 



################################################################################
############################## PARALOG COUNT TEST ##############################
################################################################################
#to look at effect of orthologous group size and number of A. millepora paralogs
#on the p values from branch sites test do this:
paralog_counts.py -go amil_defog_iso2go.tab -ortho run1.end -seq2iso amil_seq2iso.tab
#analyze output with paralog_count_test.R
################################################################################




################################################################################
################# OUTPUT AMINO ACID ALIGNMENTS FOR SELECTED GENES ##############
#here you need to go back to where you have 
#the .codon files that you used to run PAML

#for individual protein sequences:
c=c018019.codon
codon_to_fasta.py $c > $c.fasta
translate_fasta.py $c.fasta


#for a batch of sequences:
#make a tab delimited table with the contig names in first column
contigs="Amino acid transport and metabolism_branch_sites_Significant.tsv"

#and output as a job
>makeAligns;while read line; do echo "codon_to_fasta.py $line.codon > $line.fasta" >> makeAligns; echo "translate_fasta.py $line.fasta" >> makeAligns; done <$contigs
launcher_creator.py -n makeAligns -j makeAligns -w 1 -t 1:00:00 -a tagmap -N 1
sbatch makeAligns.slurm


#or run on the front nodes
#save contig list as seqs.tsv
while read line; do echo "codon_to_fasta.py $line.codon > $line.fasta"; echo "translate_fasta.py $line.fasta"; done <seqs.tsv
#####################################################################################



#to output sets of kogs use 'output_kog.R'
#to output sets of for GO terms use 'GO_MWU_Branch_sites.R' in the Acropora directory

##################################################################
############# get kog annotations for Hemond dataset #############
##################################################################

#download the Hemond dataset from here:

#reformat it so you only have the uniprot IDs

#download the uniprot protein sequences in fasta format (uniprot_sprot.fasta)

#extract the uniprot protein sequences
extract_uniprot_sequences.py -i uniprot_IDs_Hemond_etal_2014.txt -u uniprot_sprot.fasta -o Hemond_PRO.fas

#now we have a set of protein sequences representing the uniprot proteins Hemond was orthologs with

#reciprocally blast those with A. millepora proteins

paired_blasts_launcher.py *PRO.fas > doblasts
launcher_creator.py -n doblasts -j doblasts -q normal -t 8:00:00 -c 120 -a $allo -e grovesdixon@gmail.com
qsub doblasts.job


#pull reciprocal best hits
#lower coverage since the uniprots will be so long
COV="25"
PCTID="25"
>getBestHits;for file in $(ls *.br); do query=${file/-*_PRO.fas.br/}; db=${file/*-/}; echo "find_best_hits.py -br $file -query $query -db ${db/.br/} -o $query-${db/.br/}.hits -cov $COV -pctID $PCTID -e 1e-5" >> getBestHits; done
launcher_creator.py -n getBestHits -j getBestHits -q normal -t 8:00:00 -a $allo
sbatch getBestHits.slurm

#USE THE TOP HITS TO PULL OUT RECIPROCAL ORTHOLOGS
echo "get_multireciprocal_orthos2.py -hits all_top_hits.txt -fa *PRO.fas -o reciprocalOrthos_cov25_pctID50.txt -anchor Amillepora_PRO.fas" > getRecips
GDlauncher_creator.py -n getRecips -j getRecips -l getRecips.job
qsub getRecips.job


#the Amillepora_PRO.fas-Hemond_PRO.fas.hits can be used as your ortholog set

#for fisher test on Hemond or to look at particular contigs, use fisherTest_Hemond.R




#GET 1 TO 1 BEST HITS BETWEEN A.MILLEPORA AND A.CERVICORNIS TRANSCRIPTOMES
#Hemond et al. 2014 used the same transcriptome as the A.cervicornis one used here
#for better comparisons between their gene expression dataset and the PAML one
#we need 1 to 1 orthologs. Get this with just a straight reciprocal blast
#just did all this in single idev session
#set up the data
mkdir one_to_one_Amil_Acer
cp Amillepora.fa one_to_one_Amil_Acer
cp Acervicorn.fa one_to_one_Amil_Acer

#grab the best hits
#just did all this in single idev session
find_best_hits.py -br Acer_clean.fasta-Amillepora_clean.fasta.br -query Acer_clean.fasta -db Amillepora_clean.fasta -o Acer_clean.fasta-Amillepora_clean.fasta.hits -cov 25 -pctID 75
find_best_hits.py -br Amillepora_clean.fasta-Acer_clean.fasta.br -query Amillepora_clean.fasta -db Acer_clean.fasta -o Amillepora_clean.fasta-Acer_clean.hits -cov 25 -pctID 75
>all_top_hits.txt; for file in *.hits; do cat $file >> all_top_hits.txt; done
get_multireciprocal_orthos2.py -hits all_top_hits.txt -rcut 1.0 -fa *clean.fasta -o reciptAmil-Acer.tsv -anchor Amillepora_clean.fasta
#now we have reciptAmil-Acer.tsv giving our reciprocal hits
grep -v "NA" reciptAmil-Acer.tsv | wc -l
#12462 pairs
#get a nice clean one for uploading into fisherTest_Hemond.R
grep -v "NA" reciptAmil-Acer.tsv > amil-acer_pairs.tsv

##################################################################
############# Incorperating Moya et al. (2012) Data ##############
##################################################################
#DOWNLOAD READ COUNTS FROM GENE EXPRESSION OMNIBUS (accession GSE33016)
#under Samples (9): click each sample link, then download from the ftp link for read counts
#I downloaded these straight to my personal computer
curl "ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM818nnn/GSM818457/suppl/GSM818457_mRNA_01.counts.txt.gz" > cnt-1_counts.tsv.gz
curl "ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM818nnn/GSM818458/suppl/GSM818458_mRNA_02.counts.txt.gz" > cnt-2_counts.tsv.gz
curl "ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM818nnn/GSM818459/suppl/GSM818459_mRNA_03.counts.txt.gz" > cnt-3_counts.tsv.gz
curl "ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM818nnn/GSM818460/suppl/GSM818460_mRNA_04.counts.txt.gz" > ppm750-1_counts.tsv.gz
curl "ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM818nnn/GSM818461/suppl/GSM818461_mRNA_05.counts.txt.gz" > ppm750-2_counts.tsv.gz
curl "ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM818nnn/GSM818462/suppl/GSM818462_mRNA_06.counts.txt.gz" > ppm750-3_counts.tsv.gz
curl "ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM818nnn/GSM818463/suppl/GSM818463_mRNA_07.counts.txt.gz" > ppm1000-1_counts.tsv.gz
curl "ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM818nnn/GSM818464/suppl/GSM818464_mRNA_08.counts.txt.gz" > ppm1000-2_counts.tsv.gz
curl "ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM818nnn/GSM818465/suppl/GSM818465_mRNA_09.counts.txt.gz" > ppm1000-3_counts.tsv.gz
gunzip *.gz

#check the number of rows in each
for file in $(ls *.tsv); do count=$(cat $file | wc -l); echo -e "$file\t$count"; done

#switch over to 'cNNNNNN' rather than 'ClusterNNNNNN'
for file in $(ls *.tsv); do sed -i.bak 's/Cluster/c/' $file; done

#analyze with DESeq_Moya_2012.R to get 



#############################################################################################
############ FIND OUT IF A CONTIG IS DIFFERENTIALLY EXPRESSED IN HEMOND AND MOYA ############
#############################################################################################
#for moya open DESeq_for_Moya_2012
#load the last saved R image and then go to bottom and use seq2iso to grab the expression data


#use scripts fisherTest_Hemond.R and DESeq_for_Moya_2012.R to output datasets,
#then use get_diff_expression_from_pubs.R to pull results for all contigs.
#final branch-sites results table with diff expression included:
branch_sites_acro_res_with_diff_express.tsv


#############################################################
############ COMPARE KOG RESULTS ACROSS DATASETS ############
#############################################################




##############################################################
######################### REFERENCES #########################
##############################################################
Moya A, Huisman L, Ball EE, Hayward DC, Grasso LC,
	Chua CM, Woo HN, Gattuso J-P, Forêt S, Miller DJ.
	2012. Whole transcriptome analysis of the coral 
	Acropora millepora reveals complex responses to 
	CO₂-driven acidification during the initiation of
	calcification. Mol. Ecol. 21:2440–2454.

##############################################################
##############################################################







